<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tesorería - Ignis</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/tesoreria_backend.js"></script> <style>
    /* TUS ESTILOS EXACTOS */
    :root {
      --primary: #0d47a1; --secondary: #546e7a; 
      --success: #2e7d32; --warning: #f9a825; --danger: #c62828;
      --light: #f5f7fa;
    }
    body { background-color: var(--light); font-family: 'Poppins', sans-serif; color: #333; padding: 20px; }
    
    /* Header */
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .header-title h2 { margin: 0; font-weight: 600; color: var(--primary); }
    .header-title small { color: #777; }
    
    /* Stats Cards */
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid transparent; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card.blue { border-color: var(--primary); }
    .stat-card.green { border-color: var(--success); }
    .stat-card.orange { border-color: var(--warning); }
    .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
    .stat-label { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

    /* Tables */
    .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; color: #555; font-weight: 600; font-size: 0.9rem; }
    .badge-pago { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
    .bg-ordinaria { background-color: #e3f2fd; color: #1565c0; }
    .bg-extra { background-color: #fff3e0; color: #ef6c00; }

    /* Tabs */
    .nav-pills .nav-link { border-radius: 8px; color: #555; font-weight: 500; padding: 10px 20px; }
    .nav-pills .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 6px rgba(13, 71, 161, 0.3); }

    /* Forms */
    .form-label { font-weight: 500; font-size: 0.9rem; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid #ddd; padding: 10px; }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); }

    /* Loader */
    #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 20%; }
    .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div><p class="mt-2 fw-bold text-secondary">Procesando...</p></div>

  <div class="container-fluid">
    
    <div class="header-bar">
      <div class="header-title">
        <h2><i class="fas fa-wallet me-2"></i>Tesorería</h2>
        <small>Gestión Financiera de la Compañía</small>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left me-1"></i> Salir
        </button>
      </div>
    </div>

    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="tab-dashboard" data-bs-toggle="pill" data-bs-target="#content-dashboard" type="button">Dashboard</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tab-pagos" data-bs-toggle="pill" data-bs-target="#content-pagos" type="button">Registrar Pago</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tab-historial" data-bs-toggle="pill" data-bs-target="#content-historial" type="button">Historial</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tab-admin" data-bs-toggle="pill" data-bs-target="#content-admin" type="button">Administración</button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

      <div class="tab-pane fade show active" id="content-dashboard">
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="stat-card blue">
              <div class="stat-label">Recaudación Mes Actual</div>
              <div class="stat-value text-primary" id="dashRecaudado">$0</div>
              <div class="progress mt-2" style="height: 5px;">
                <div class="progress-bar" id="barraMeta" role="progressbar" style="width: 0%"></div>
              </div>
              <small class="text-muted mt-1 d-block" id="dashMeta">Meta: $0</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card orange">
              <div class="stat-label">Morosidad Total</div>
              <div class="stat-value text-warning" id="dashMorosidad">Calculando...</div>
              <small class="text-muted">Voluntarios con deuda > 3 meses</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card green">
              <div class="stat-label">Caja Chica</div>
              <div class="stat-value text-success">$150.000</div>
              <small class="text-muted">Saldo disponible</small>
            </div>
          </div>
        </div>
        
        <div class="table-container">
          <h5 class="mb-3 text-secondary"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Alertas de Morosidad</h5>
          <div class="alert alert-info">
            La lista de morosos se calculará automáticamente en base a las cuotas impagas.
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="content-pagos">
        <div class="row">
          <div class="col-md-4">
            <div class="table-container mb-3">
              <h5 class="mb-3">Nuevo Pago</h5>
              <div class="mb-3">
                <label class="form-label">Buscar Voluntario</label>
                <input type="text" id="busqVoluntario" class="form-control" placeholder="Escriba nombre o RUT..." onkeyup="filtrarTablaDeudas()">
              </div>
              <div class="alert alert-warning small">
                <i class="fas fa-info-circle me-1"></i> Seleccione una deuda de la lista de la derecha para pagar.
              </div>
              <form id="formPago" style="display:none;">
                <input type="hidden" id="pagoIdDeuda">
                <input type="hidden" id="pagoTipoDeuda"> <div class="mb-2">
                  <label class="form-label">Voluntario</label>
                  <input type="text" id="pagoNombre" class="form-control bg-light" readonly>
                </div>
                <div class="mb-2">
                  <label class="form-label">Concepto</label>
                  <input type="text" id="pagoConcepto" class="form-control bg-light" readonly>
                </div>
                <div class="mb-2">
                  <label class="form-label">Monto a Pagar</label>
                  <input type="number" id="pagoMonto" class="form-control fw-bold text-primary">
                </div>
                <div class="mb-3">
                  <label class="form-label">Método</label>
                  <select id="pagoMetodo" class="form-select">
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                  </select>
                </div>
                <button type="button" class="btn btn-success w-100" onclick="confirmarPago()">
                  <i class="fas fa-check-circle me-2"></i> CONFIRMAR PAGO
                </button>
                <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="cancelarSeleccion()">
                  Cancelar
                </button>
              </form>
            </div>
          </div>

          <div class="col-md-8">
            <div class="table-container">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Deudas Pendientes</h5>
                <button class="btn btn-sm btn-primary" onclick="cargarDeudas()"><i class="fas fa-sync-alt"></i> Actualizar</button>
              </div>
              <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle">
                  <thead style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                      <th>Voluntario</th>
                      <th>Tipo</th>
                      <th>Detalle</th>
                      <th>Monto</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody id="tablaDeudas">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="content-historial">
        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Historial de Transacciones</h5>
            <div>
               <input type="text" id="filtroHistorial" class="form-control form-control-sm d-inline-block w-auto" placeholder="Filtrar..." onkeyup="filtrarHistorial()">
               <button class="btn btn-sm btn-success ms-2" onclick="exportarExcel()"><i class="fas fa-file-excel me-1"></i> Excel</button>
            </div>
          </div>
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Voluntario</th>
                <th>Tipo</th>
                <th>Detalle</th>
                <th>Monto</th>
                <th>Método</th>
              </tr>
            </thead>
            <tbody id="tablaHistorial">
              </tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="content-admin">
        <div class="row">
          <div class="col-md-6">
            <div class="table-container">
              <h5 class="text-primary mb-3"><i class="fas fa-calendar-check me-2"></i>Generación Masiva de Cuotas</h5>
              <p class="text-muted small">Genera la cuota ordinaria para TODOS los voluntarios activos.</p>
              
              <div class="row g-2 align-items-end">
                <div class="col-6">
                  <label class="form-label">Mes</label>
                  <select id="mesMasivo" class="form-select">
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Año</label>
                  <input type="number" id="anioMasivo" class="form-control" value="2026">
                </div>
                <div class="col-12 mt-3">
                  <button class="btn btn-primary w-100" onclick="ejecutarGeneracionMasiva()">
                    <i class="fas fa-cogs me-2"></i> GENERAR CUOTAS
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="table-container">
              <h5 class="text-danger mb-3"><i class="fas fa-ticket-alt me-2"></i>Cobro Extraordinario</h5>
              <p class="text-muted small">Genera rifas, cuotas de mortuoria o bonos.</p>
              
              <div class="mb-2">
                <label class="form-label">Motivo</label>
                <input type="text" id="motivoExtra" class="form-control" placeholder="Ej: Rifa Anual 2026">
              </div>
              <div class="mb-3">
                <label class="form-label">Monto</label>
                <input type="number" id="montoExtra" class="form-control">
              </div>
              <button class="btn btn-danger w-100" onclick="generarCobroExtra()">
                <i class="fas fa-plus-circle me-2"></i> ASIGNAR COBRO A TODOS
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Variables globales para la tabla filtrable
    let datosDeudaCache = [];
    let historialCache = [];

    document.addEventListener("DOMContentLoaded", async function() {
        mostrarLoader();
        try {
            // 1. Cargar Dashboard
            const dash = await getDatosDashboard();
            
            // Formatear dinero
            const fmt = (n) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(n);
            
            document.getElementById('dashRecaudado').innerText = fmt(dash.recaudado);
            document.getElementById('dashMeta').innerText = "Meta: " + fmt(dash.meta);
            
            // Barra de progreso
            let porc = 0;
            if(dash.meta > 0) porc = Math.min(100, Math.round((dash.recaudado / dash.meta) * 100));
            
            const barra = document.getElementById('barraMeta');
            barra.style.width = porc + "%";
            barra.innerText = porc + "%";
            if(porc < 50) barra.className = "progress-bar bg-danger";
            else if(porc < 80) barra.className = "progress-bar bg-warning";
            else barra.className = "progress-bar bg-success";

            document.getElementById('dashMorosidad').innerText = dash.morosos;

            // 2. Cargar Deudas
            await cargarDeudas();

            // 3. Cargar Historial
            await cargarHistorial();

        } catch (e) {
            console.error(e);
            Swal.fire("Error", "No se pudieron cargar los datos iniciales.", "error");
        } finally {
            ocultarLoader();
        }
    });

    async function cargarDeudas() {
        const lista = await getListaCobro();
        datosDeudaCache = lista;
        renderDeudas(lista);
    }

    function renderDeudas(lista) {
        const tbody = document.getElementById('tablaDeudas');
        tbody.innerHTML = "";
        
        lista.forEach(d => {
            const tr = document.createElement('tr');
            const badgeClass = d.tipo === 'ORDINARIA' ? 'bg-ordinaria' : 'bg-extra';
            const fmtMonto = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(d.monto);
            
            tr.innerHTML = `
                <td><div class="fw-bold">${d.nombre}</div><small class="text-muted">${d.rut}</small></td>
                <td><span class="badge ${badgeClass} badge-pago">${d.tipo}</span></td>
                <td>${d.detalle}</td>
                <td class="fw-bold text-dark">${fmtMonto}</td>
                <td>
                    <button class="btn btn-sm btn-outline-success" onclick='seleccionarDeuda(${JSON.stringify(d)})'>
                        <i class="fas fa-hand-holding-usd"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function seleccionarDeuda(d) {
        document.getElementById('formPago').style.display = 'block';
        document.getElementById('pagoIdDeuda').value = d.id;
        document.getElementById('pagoTipoDeuda').value = d.tipo; // ORDINARIA o EXTRA
        document.getElementById('pagoNombre').value = d.nombre;
        document.getElementById('pagoConcepto').value = d.tipo + " - " + d.detalle;
        document.getElementById('pagoMonto').value = d.monto;
        document.getElementById('pagoMonto').focus();
    }

    function cancelarSeleccion() {
        document.getElementById('formPago').reset();
        document.getElementById('formPago').style.display = 'none';
    }

    async function confirmarPago() {
        const id = document.getElementById('pagoIdDeuda').value;
        const tipo = document.getElementById('pagoTipoDeuda').value;
        const monto = document.getElementById('pagoMonto').value;
        const metodo = document.getElementById('pagoMetodo').value;
        const nombre = document.getElementById('pagoNombre').value;

        if(!id || !monto) return Swal.fire("Error", "Seleccione una deuda primero", "warning");

        const confirmacion = await Swal.fire({
            title: '¿Registrar Pago?',
            text: `Se registrará $${monto} para ${nombre}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, Pagar'
        });

        if (confirmacion.isConfirmed) {
            mostrarLoader();
            const res = await registrarPago({ id, tipo, monto, metodo });
            ocultarLoader();
            
            if (res.ok) {
                Swal.fire("Éxito", "Pago registrado correctamente", "success");
                cancelarSeleccion();
                cargarDeudas(); // Recargar lista
                cargarHistorial(); // Recargar historial
                // Actualizar dashboard (simple reload de parte o toda la pag)
                getDatosDashboard().then(dash => {
                   document.getElementById('dashRecaudado').innerText = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(dash.recaudado);
                });
            } else {
                Swal.fire("Error", "No se pudo registrar el pago: " + res.msg, "error");
            }
        }
    }

    // --- FILTRADO EN CLIENTE (Para mantener la velocidad de GAS) ---
    function filtrarTablaDeudas() {
        const q = document.getElementById('busqVoluntario').value.toUpperCase();
        const filtrados = datosDeudaCache.filter(d => 
            d.nombre.toUpperCase().includes(q) || 
            d.rut.toUpperCase().includes(q)
        );
        renderDeudas(filtrados);
    }

    // --- HISTORIAL ---
    async function cargarHistorial() {
        const lista = await getHistorialPagos();
        historialCache = lista;
        renderHistorial(lista);
    }

    function renderHistorial(lista) {
        const tbody = document.getElementById('tablaHistorial');
        tbody.innerHTML = "";
        lista.forEach(p => {
            const tr = document.createElement('tr');
            const fecha = new Date(p.fecha_registro).toLocaleDateString();
            const fmtMonto = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.monto_pagado);
            tr.innerHTML = `
                <td>${fecha}</td>
                <td>${p.rut}</td> <td>${p.tipo}</td>
                <td>${p.mes}</td>
                <td>${fmtMonto}</td>
                <td>${p.metodo}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filtrarHistorial() {
        const q = document.getElementById('filtroHistorial').value.toUpperCase();
        const filtrados = historialCache.filter(p => 
            String(p.rut).toUpperCase().includes(q) || 
            String(p.tipo).toUpperCase().includes(q) ||
            String(p.mes).toUpperCase().includes(q)
        );
        renderHistorial(filtrados);
    }

    function exportarExcel() {
        let csvContent = "data:text/csv;charset=utf-8,Fecha,RUT,Tipo,Detalle,Monto,Metodo\n";
        historialCache.forEach(p => {
             const fecha = new Date(p.fecha_registro).toLocaleDateString();
             csvContent += `${fecha},${p.rut},${p.tipo},${p.mes},${p.monto_pagado},${p.metodo}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "historial_pagos.csv");
        document.body.appendChild(link);
        link.click();
    }

    // --- ADMIN ---
    async function ejecutarGeneracionMasiva() {
        const anio = document.getElementById('anioMasivo').value;
        const mes = document.getElementById('mesMasivo').value;

        if(!confirm(`¿Desea generar las cuotas de TODOS los voluntarios para el mes ${mes} del año ${anio}?`)) return;

        mostrarLoader();
        const res = await generarCuotasMasivas(anio, mes);
        ocultarLoader();

        if(res.ok) {
            Swal.fire("Proceso Terminado", `Se generaron ${res.cantidad} cuotas nuevas.`, "success");
            cargarDeudas();
        } else {
            Swal.fire("Error", res.msg, "error");
        }
    }

    async function generarCobroExtra() {
        const motivo = document.getElementById('motivoExtra').value;
        const monto = document.getElementById('montoExtra').value;

        if(!motivo || !monto) return Swal.fire("Atención", "Complete motivo y monto", "warning");
        if(!confirm(`¿Generar cobro de $${monto} por '${motivo}' a TODOS los voluntarios?`)) return;

        mostrarLoader();
        const res = await generarCobroExtraMasivo(motivo, monto);
        ocultarLoader();

        if(res.ok) {
            Swal.fire("Éxito", `Se asignó el cobro a ${res.cantidad} voluntarios.`, "success");
            cargarDeudas();
        } else {
            Swal.fire("Error", res.msg, "error");
        }
    }

    // Helpers UI
    function mostrarLoader() { document.getElementById('loader').style.display = 'block'; }
    function ocultarLoader() { document.getElementById('loader').style.display = 'none'; }
    function normalizarRut(rut) { return String(rut).toUpperCase().replace(/[^0-9K]/g, ""); } // Mismo que Utils
  </script>
</body>
</html>
