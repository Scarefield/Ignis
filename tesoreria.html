<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tesorería - Ignis</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/tesoreria_backend.js"></script> <style>
    :root {
      --primary: #0d47a1; --secondary: #546e7a; 
      --success: #2e7d32; --warning: #f9a825; --danger: #c62828;
      --light: #f5f7fa;
    }
    body { background-color: var(--light); font-family: 'Poppins', sans-serif; color: #333; padding: 20px; }
    
    /* Header */
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .header-title h2 { margin: 0; font-weight: 600; color: var(--primary); }
    .header-title small { color: #777; }
    
    /* Stats Cards */
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid transparent; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card.blue { border-color: var(--primary); }
    .stat-card.green { border-color: var(--success); }
    .stat-card.orange { border-color: var(--warning); }
    .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
    .stat-label { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

    /* Tables */
    .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; color: #555; font-weight: 600; font-size: 0.9rem; }
    .badge-pago { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
    .bg-ordinaria { background-color: #e3f2fd; color: #1565c0; }
    .bg-extra { background-color: #fff3e0; color: #ef6c00; }

    /* Loader */
    #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 20%; }
    .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div><p class="mt-2 fw-bold text-secondary">Procesando...</p></div>

  <div class="container-fluid">
    
    <div class="header-bar">
      <div class="header-title">
        <h2><i class="fas fa-wallet me-2"></i>Tesorería</h2>
        <small>Gestión Financiera - Ignis V2</small>
      </div>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left me-1"></i> Salir
        </button>
      </div>
    </div>

    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#content-dashboard">Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-pagos">Registrar Pago</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-historial">Historial</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#content-admin">Administración</button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

      <div class="tab-pane fade show active" id="content-dashboard">
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="stat-card blue">
              <div class="stat-label">Recaudación Mes Actual</div>
              <div class="stat-value text-primary" id="dashRecaudado">$0</div>
              <div class="progress mt-2" style="height: 5px;">
                <div class="progress-bar" id="barraMeta" role="progressbar" style="width: 0%"></div>
              </div>
              <small class="text-muted mt-1 d-block" id="dashMeta">Meta: $0</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card orange">
              <div class="stat-label">Morosidad Total</div>
              <div class="stat-value text-warning" id="dashMorosidad">...</div>
              <small class="text-muted">Cuotas ordinarias vencidas</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card green">
              <div class="stat-label">Caja Chica</div>
              <div class="stat-value text-success">$150.000</div>
              <small class="text-muted">Saldo disponible</small>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="content-pagos">
        <div class="row">
          <div class="col-md-4">
            <div class="table-container mb-3">
              <h5 class="mb-3">Nuevo Pago</h5>
              <div class="mb-3">
                <input type="text" id="busqVoluntario" class="form-control" placeholder="Buscar por Nombre o RUT..." onkeyup="filtrarTablaDeudas()">
              </div>
              
              <form id="formPago" style="display:none;">
                <input type="hidden" id="pagoIdDeuda">
                <input type="hidden" id="pagoOrigen"> 
                <input type="hidden" id="pagoRutVol">
                
                <div class="mb-2">
                  <label class="form-label">Voluntario</label>
                  <input type="text" id="pagoNombre" class="form-control bg-light" readonly>
                </div>
                <div class="mb-2">
                  <label class="form-label">Concepto</label>
                  <input type="text" id="pagoConcepto" class="form-control bg-light" readonly>
                </div>
                <div class="mb-2">
                  <label class="form-label">Monto a Pagar</label>
                  <input type="number" id="pagoMonto" class="form-control fw-bold text-primary">
                </div>
                <div class="mb-3">
                  <label class="form-label">Método</label>
                  <select id="pagoMetodo" class="form-select">
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                  </select>
                </div>
                <button type="button" class="btn btn-success w-100" onclick="confirmarPago()">
                  <i class="fas fa-check-circle me-2"></i> CONFIRMAR PAGO
                </button>
                <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="cancelarSeleccion()">
                  Cancelar
                </button>
              </form>
            </div>
          </div>

          <div class="col-md-8">
            <div class="table-container">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Deudas Pendientes</h5>
                <button class="btn btn-sm btn-primary" onclick="cargarDeudas()"><i class="fas fa-sync-alt"></i> Actualizar</button>
              </div>
              <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle">
                  <thead><tr><th>Voluntario</th><th>Tipo</th><th>Detalle</th><th>Monto</th><th></th></tr></thead>
                  <tbody id="tablaDeudas"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="content-historial">
        <div class="table-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Historial de Transacciones</h5>
            <div>
              <button class="btn btn-sm btn-primary" onclick="cargarHistorial()"><i class="fas fa-sync"></i></button>
              <button class="btn btn-sm btn-success ms-2" onclick="exportarExcel()"><i class="fas fa-file-excel me-1"></i> Excel</button>
            </div>
          </div>
          <table class="table table-striped table-sm">
            <thead><tr><th>Fecha</th><th>RUT</th><th>Tipo</th><th>Detalle</th><th>Monto</th><th>Método</th></tr></thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="content-admin">
        <div class="row g-4">
          
          <div class="col-md-6">
            <div class="table-container h-100">
              <h5 class="text-primary mb-3"><i class="fas fa-users-cog me-2"></i>Generación Masiva</h5>
              <p class="text-muted small">
                Calcula automáticamente:
                <br>• Cuota Normal vs Estudiante
                <br>• Exención de Insignes
                <br>• Descuentos por Guardia Nocturna
              </p>
              <div class="row g-2 align-items-end">
                <div class="col-6">
                  <label class="form-label">Mes</label>
                  <select id="mesMasivo" class="form-select">
                    <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                    <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                    <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                    <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Año</label>
                  <input type="number" id="anioMasivo" class="form-control" value="2026">
                </div>
                <div class="col-12 mt-3">
                  <button class="btn btn-primary w-100" onclick="ejecutarGeneracionMasiva()">
                    GENERAR CUOTAS
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="table-container h-100">
              <h5 class="text-danger mb-3"><i class="fas fa-ticket-alt me-2"></i>Cobro Extraordinario</h5>
              <div class="mb-2">
                <label class="form-label">Motivo</label>
                <input type="text" id="motivoExtra" class="form-control" placeholder="Ej: Rifa Anual">
              </div>
              <div class="mb-3">
                <label class="form-label">Monto</label>
                <input type="number" id="montoExtra" class="form-control">
              </div>
              <button class="btn btn-danger w-100" onclick="generarCobroExtra()">
                ASIGNAR A TODOS
              </button>
            </div>
          </div>

          <div class="col-12">
            <div class="table-container border-top border-3 border-secondary">
              <h5 class="text-secondary mb-3"><i class="fas fa-user-edit me-2"></i>Generación Individual / Manual</h5>
              <p class="text-muted small">Crea una cuota específica para un voluntario, ignorando reglas automáticas (Ideal para correcciones).</p>
              
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">RUT Voluntario</label>
                  <input type="text" id="rutIndiv" class="form-control" placeholder="12345678-K">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Mes</label>
                  <select id="mesIndiv" class="form-select">
                    <option value="1">Ene</option><option value="2">Feb</option><option value="3">Mar</option>
                    <option value="4">Abr</option><option value="5">May</option><option value="6">Jun</option>
                    <option value="7">Jul</option><option value="8">Ago</option><option value="9">Sep</option>
                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dic</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Año</label>
                  <input type="number" id="anioIndiv" class="form-control" value="2026">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Monto Personalizado</label>
                  <input type="number" id="montoIndiv" class="form-control" placeholder="$">
                </div>
                <div class="col-md-2">
                  <button class="btn btn-secondary w-100" onclick="crearCuotaIndividual()">CREAR</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    let cacheDeudas = [];
    let cacheHistorial = []; // Para el Excel

    document.addEventListener("DOMContentLoaded", function() {
        const hoy = new Date();
        // Setear selects al mes actual
        document.getElementById('mesMasivo').value = hoy.getMonth() + 1;
        document.getElementById('mesIndiv').value = hoy.getMonth() + 1;
        
        cargarDashboard();
        cargarDeudas();
        cargarHistorial();
    });

    // --- DASHBOARD ---
    async function cargarDashboard() {
        const data = await getDatosDashboard();
        const fmt = (n) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(n);
        
        document.getElementById('dashRecaudado').innerText = fmt(data.recaudado);
        document.getElementById('dashMeta').innerText = "Meta: " + fmt(data.meta);
        document.getElementById('dashMorosidad').innerText = data.morosos;
        
        let porc = 0;
        if(data.meta > 0) porc = Math.min(100, (data.recaudado / data.meta) * 100);
        const barra = document.getElementById('barraMeta');
        barra.style.width = porc + "%";
        if(porc < 50) barra.className = "progress-bar bg-danger";
        else if(porc < 80) barra.className = "progress-bar bg-warning";
        else barra.className = "progress-bar bg-success";
    }

    // --- DEUDAS ---
    async function cargarDeudas() {
        mostrarLoader();
        const lista = await getListaCobro();
        ocultarLoader();
        cacheDeudas = lista;
        renderDeudas(lista);
    }

    function renderDeudas(lista) {
        const tb = document.getElementById('tablaDeudas');
        tb.innerHTML = "";
        lista.forEach(d => {
            const tr = document.createElement('tr');
            const fmtMonto = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(d.monto);
            const badge = d.tipo === 'ORDINARIA' ? 'bg-ordinaria' : 'bg-extra';
            
            tr.innerHTML = `
                <td><b>${d.nombre}</b><br><small>${d.rut}</small></td>
                <td><span class="badge ${badge} badge-pago">${d.tipo}</span></td>
                <td>${d.detalle}</td>
                <td class="fw-bold">${fmtMonto}</td>
                <td><button class="btn btn-sm btn-outline-success" onclick='seleccionar(${JSON.stringify(d)})'><i class="fas fa-hand-holding-usd"></i></button></td>
            `;
            tb.appendChild(tr);
        });
    }

    function filtrarTablaDeudas() {
        const q = document.getElementById('busqVoluntario').value.toUpperCase();
        const filtrados = cacheDeudas.filter(d => d.nombre.toUpperCase().includes(q) || d.rut.includes(q));
        renderDeudas(filtrados);
    }

    // --- PAGO ---
    function seleccionar(d) {
        document.getElementById('formPago').style.display = 'block';
        document.getElementById('pagoIdDeuda').value = d.id;
        document.getElementById('pagoOrigen').value = d.origen; // 'ordinaria' o 'extra'
        document.getElementById('pagoRutVol').value = d.rut;
        document.getElementById('pagoNombre').value = d.nombre;
        document.getElementById('pagoConcepto').value = d.detalle;
        document.getElementById('pagoMonto').value = d.monto;
        document.getElementById('pagoMonto').focus();
    }

    function cancelarSeleccion() {
        document.getElementById('formPago').style.display = 'none';
    }

    async function confirmarPago() {
        const id = document.getElementById('pagoIdDeuda').value;
        const origen = document.getElementById('pagoOrigen').value;
        const rut = document.getElementById('pagoRutVol').value;
        const concepto = document.getElementById('pagoConcepto').value;
        const monto = document.getElementById('pagoMonto').value;
        const metodo = document.getElementById('pagoMetodo').value;

        if(!monto || monto <= 0) return Swal.fire("Error", "Monto inválido", "warning");

        mostrarLoader();
        const res = await registrarPago(id, origen, (origen==='ordinaria'?'ORDINARIA':'EXTRA'), monto, metodo, rut, concepto);
        ocultarLoader();

        if(res.ok) {
            Swal.fire("Éxito", "Pago registrado", "success");
            cancelarSeleccion();
            cargarDashboard();
            cargarDeudas();
            cargarHistorial();
        } else {
            Swal.fire("Error", res.msg, "error");
        }
    }

    // --- HISTORIAL & EXCEL ---
    async function cargarHistorial() {
        const lista = await getHistorialPagos();
        cacheHistorial = lista; // Guardar para Excel
        const tb = document.getElementById('tablaHistorial');
        tb.innerHTML = "";
        lista.forEach(p => {
            const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(p.monto);
            tb.innerHTML += `<tr><td>${p.fecha}</td><td>${p.rut}</td><td>${p.tipo}</td><td>${p.detalle}</td><td>${fmt}</td><td>${p.metodo}</td></tr>`;
        });
    }

    function exportarExcel() {
        if(!cacheHistorial || cacheHistorial.length === 0) return Swal.fire("Aviso", "No hay datos para exportar", "info");
        
        let csv = "Fecha;RUT;Tipo;Detalle;Monto;Metodo\n";
        cacheHistorial.forEach(Row => {
            csv += `${Row.fecha};${Row.rut};${Row.tipo};${Row.detalle};${Row.monto};${Row.metodo}\n`;
        });

        const bom = "\uFEFF"; // Para que Excel reconozca tildes
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "historial_pagos.csv";
        link.click();
    }

    // --- ADMIN (MASIVO & INDIVIDUAL) ---
    async function ejecutarGeneracionMasiva() {
        const m = document.getElementById('mesMasivo').value;
        const a = document.getElementById('anioMasivo').value;
        if(!confirm(`⚠️ PROCESO CRÍTICO\n\nSe generarán las cuotas para ${m}/${a} aplicando:\n- Descuentos por Guardia\n- Tarifas Estudiante\n- Exención Insignes\n\n¿Proceder?`)) return;

        mostrarLoader();
        const res = await generarCuotasMasivas(a, m);
        ocultarLoader();

        if(res.ok) Swal.fire("Finalizado", res.msg, "success");
        else Swal.fire("Error", res.msg, "error");
    }

    async function generarCobroExtra() {
        const mot = document.getElementById('motivoExtra').value;
        const mon = document.getElementById('montoExtra').value;
        if(!mot || !mon) return Swal.fire("Datos incompletos");
        if(!confirm(`¿Generar cobro de $${mon} por "${mot}" a TODOS los voluntarios activos?`)) return;

        mostrarLoader();
        const res = await generarCobroExtraMasivo(mot, mon);
        ocultarLoader();
        if(res.ok) Swal.fire("Listo", `Se generaron ${res.count} cobros extras.`, "success");
        else Swal.fire("Error", res.msg, "error");
    }

    async function crearCuotaIndividual() {
        const rut = document.getElementById('rutIndiv').value;
        const mes = document.getElementById('mesIndiv').value;
        const anio = document.getElementById('anioIndiv').value;
        const monto = document.getElementById('montoIndiv').value;

        if(!rut || !monto) return Swal.fire("Atención", "Ingrese RUT y Monto", "warning");

        mostrarLoader();
        // Llamada a la función del backend que creamos para esto
        const res = await generarCuotaIndividual(rut, anio, mes, monto);
        ocultarLoader();

        if(res.ok) {
            Swal.fire("Éxito", "Cuota individual creada.", "success");
            cargarDeudas(); // Refrescar lista para verla
        } else {
            Swal.fire("Error", res.msg, "error");
        }
    }

    function mostrarLoader() { document.getElementById('loader').style.display = 'block'; }
    function ocultarLoader() { document.getElementById('loader').style.display = 'none'; }
  </script>
</body>
</html>
</html>
